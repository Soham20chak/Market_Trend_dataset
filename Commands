cd home
cd ubh01
cd hadoop-2.7.1
cd sbin
./start-dfs.sh
./start-yarn.sh
jps
hadoop fs -mkdir -p /home/ubh01/ecommercedata
hadoop fs -put /home/ubh01/Downloads/OnlineRetail.csv /home/ubh01/ecommercedata


hive
hive
use default;
create table online_market(invoice_no string,stock_code string,item string,quantity int,invoice_date string,unit_price float,cust_id int,country string) row format delimited fields terminated by ',' stored as textfile location '/home/ubh01/ecommercedata/';

partitioning :
static -
create table static_partition_table(invoice_no string,stock_code string,cust_id int,item string,quantity int,invoice_date string,unit_price float) partitioned by (country string);

insert into table static_partition_table partition(country='France') select invoice_no,stock_code,item,quantity,invoice_date,unit_price,cust_id from online_market where country='France';
insert into table static_partition_table partition(country='Netherlands') select invoice_no,stock_code,item,quantity,invoice_date,unit_price,cust_id from online_market where country='Netherlands';
insert into table static_partition_table partition(country='Australia') select invoice_no,stock_code,item,quantity,invoice_date,unit_price,cust_id from online_market where country='Australia';
select * from static_partition_table;

dynamic -
hive> set hive.exec.dynamic.partition.mode=nonstrict;
hive> create table dynamic_partition_table(invoice_no string,stock_code string,citem string,quantity int,invoice_date string,unit_price float,ust_id int) partitioned by (country string);

insert into table dynamic_partition_table partition(country) select invoice_no,stock_code,item,quantity,invoice_date,unit_price,cust_id,country from online_market ;

-- Query total sales revenue by country
SELECT country, SUM(quantity * unit_price) AS total_sales_revenue
FROM dynamic_partition_table
GROUP BY country;

-- Query top selling items in a specific country
SELECT country, item, SUM(quantity) AS total_quantity_sold
FROM dynamic_partition_table
WHERE country = 'United Kingdom'
GROUP BY country, item
ORDER BY total_quantity_sold DESC;

-- Query sales trends over time for a specific country
SELECT country, substring(invoice_date,1,2) AS month, SUM(quantity) AS total_quantity_sold
FROM dynamic_partition_table
WHERE country = 'Netherlands'
GROUP BY country, substring(invoice_date,1,2)
ORDER BY substring(invoice_date,1,2);

hive>  set hive.log.explain.output=true;
hive> set hive.exec.reducers.bytes.per.reducer=256000000;
select count(*) from online_market where country='France';
hive> select count(*) from dynamic_partition_table where country='France';


bucketing - 
create table bucketing_table(invoice_no int,stock_code string,item string,quantity int,invoice_date date,unit_price float,cust_id int,country string) clustered by (unit_price) into 10 buckets stored as textfile;

insert into bucketing_table select * from online_market;

SELECT *
FROM bucketing_table
WHERE unit_price >= 100;

SELECT COUNT(*)
FROM bucketing_table
GROUP BY unit_price;

Partitioning with bucketing :-
CREATE TABLE ecommerce_partitioned_bucketed (
    invoice_no STRING,
    stockcode STRING,
    item STRING,
    quantity INT,
    invoice_date STRING,
    unit_price FLOAT,
    customer_id STRING
)
PARTITIONED BY (country STRING)
CLUSTERED BY (unit_price) INTO 15 BUCKETS;

INSERT OVERWRITE TABLE ecommerce_partitioned_bucketed
PARTITION (country)
SELECT invoice_no, stock_code, item, quantity, invoice_date, unit_price, cust_id, country
FROM online_market;

aggregating using country and unit_price buckets
SELECT country, unit_price_bucket, SUM(quantity) AS total_quantity, SUM(quantity * unit_price) AS total_revenue
FROM (
    SELECT country, NTILE(10) OVER (PARTITION BY country ORDER BY unit_price) AS unit_price_bucket, quantity, unit_price
    FROM ecommerce_partitioned_bucketed
) t
GROUP BY country, unit_price_bucket;

Queries - 
Sales Analysis - 

-- Total sales revenue
SELECT SUM(quantity * unit_price) AS total_sales_revenue FROM online_market;

-- Top selling items
SELECT item, SUM(quantity) AS total_quantity_sold FROM online_market GROUP BY item ORDER BY total_quantity_sold DESC limit 10;

Inventory analysis -
-- Inventory turnover rate
SELECT SUM(quantity) / COUNT(DISTINCT invoice_no) AS inventory_turnover_rate FROM online_market;

Customer analysis -
-- Customer segmentation based on purchasing behavior
SELECT cust_id, SUM(quantity) AS total_quantity_purchased
FROM online_market
GROUP BY cust_id limit 20;

-- Customer churn analysis
SELECT cust_id, COUNT(DISTINCT invoice_no) AS total_invoices
FROM online_market where cust_id is not null
GROUP BY cust_id limit 20;

Forecasting and Predictive Analytics:
-- Sales forecasting
SELECT substring(invoice_date,1,2), SUM(quantity) AS total_quantity_sold FROM online_market group by substring(invoice_date,1,2);



select sum(quantity*unit_price) , 
    > case 
    > when substring(invoice_date,1,2)='1/' then 'January'
    > when substring(invoice_date,1,2)='2/' then 'February'
    > when substring(invoice_date,1,2)='3/' then 'March'
    > when substring(invoice_date,1,2)='4/' then 'April'
    > when substring(invoice_date,1,2)='5/' then 'May'
    > when substring(invoice_date,1,2)='6/' then 'June'
    > when substring(invoice_date,1,2)='7/' then 'July'
    > when substring(invoice_date,1,2)='8/' then 'August'
    > when substring(invoice_date,1,2)='10' then 'October'
    > when substring(invoice_date,1,2)='9/' then 'September'
    > when substring(invoice_date,1,2)='11' then 'November'
    > when substring(invoice_date,1,2)='12' then 'December'
    > end as Month from online_market group by substring(invoice_date,1,2); 



